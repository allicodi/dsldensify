% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/utils.R
\name{run_hurdle_setting}
\alias{run_hurdle_setting}
\title{Evaluate hurdle probability learners for a fixed hurdle point under cross-validation}
\usage{
run_hurdle_setting(
  A,
  W,
  wts,
  hurdle_point = 0,
  cv_folds_id,
  id_fold,
  ids_full = NULL,
  learners,
  return_fits = TRUE,
  eps = 1e-15,
  ...
)
}
\arguments{
\item{A}{Numeric vector of outcomes of length \code{n}.}

\item{W}{Covariates used to model the hurdle probability. May be a vector,
matrix, \code{data.frame}, or \code{data.table}. Must have \code{n} rows.}

\item{wts}{Numeric vector of nonnegative observation weights of length
\code{n}. Used to define fold weights and passed to learners via the
\code{wts} column in the constructed wide data.}

\item{hurdle_point}{Numeric scalar giving the point mass location \eqn{a_0}.
The hurdle indicator is \code{in_hurdle = as.integer(A == hurdle_point)}.}

\item{cv_folds_id}{Fold object (list) defining validation indices for each
fold. Each element \code{cv_folds_id[[v]]} must contain
\code{$validation_set}, an integer vector of indices in \code{1:n}.}

\item{id_fold}{Integer vector of length \code{n} giving fold assignments for
each observation (values in \code{1, ..., V}). Used to split the constructed
wide data into training and validation partitions.}

\item{ids_full}{Optional integer vector of length \code{n} mapping the current
\code{A}/\code{W} rows to full-data row indices. If \code{NULL}, defaults to
\code{seq_along(A)}. Stored in the fold outputs as \code{validation_ids_full}
for downstream alignment.}

\item{learners}{Named list of hurdle runner objects. Each runner must provide
\code{fit(train_set, ...)} and \code{logpi(fit_bundle, newdata, ...)}.
The \code{logpi()} method must return \eqn{\log \hat\pi(W)} evaluated on
\code{newdata}, as either a vector (treated as \eqn{K=1}) or a matrix with
one column per tuning choice.}

\item{return_fits}{Logical; if \code{TRUE}, include the fitted learner bundle
in each fold learner output under \code{$fit}. If \code{FALSE}, omit fits and
retain only fold losses and predicted quantities.}

\item{eps}{Small positive constant used to bound \eqn{\hat\pi(W)} away from
\code{0} and \code{1} when converting \eqn{\log \hat\pi(W)} to \eqn{\hat\pi(W)}
for stable evaluation of \eqn{\log\{1-\hat\pi(W)\}}.}

\item{...}{Additional arguments passed through to \code{runner$fit()} and
\code{runner$logpi()}.}
}
\value{
A named list with elements:
\describe{
  \item{\code{cv_out}}{List of length \eqn{V}. Each element is a fold object
    containing \code{fold}, \code{fold_weight}, \code{learners},
    \code{validation_ids_full}, \code{valid_in_hurdle}, and \code{wts_valid}.}
  \item{\code{hurdle_point}}{The \code{hurdle_point} value used to define the
    hurdle indicator.}
  \item{\code{grid_type}}{Character string \code{"hurdle"}.}
}

Fold learner outputs (stored in \code{cv_out[[v]]$learners[[name]]}) contain:
\describe{
  \item{\code{learner}}{Learner name.}
  \item{\code{fold}}{Fold index.}
  \item{\code{loss}}{Matrix of Bernoulli negative log-likelihood losses of
    dimension \eqn{n_{\mathrm{valid}} \times K}.}
  \item{\code{logpi}}{Matrix of predicted \eqn{\log \hat\pi(W)} values of
    dimension \eqn{n_{\mathrm{valid}} \times K}.}
  \item{\code{fit}}{Optional fitted bundle returned by \code{runner$fit()}
    (present only if \code{return_fits = TRUE}).}
}
}
\description{
Fits and evaluates a set of hurdle probability learners for the event
\eqn{A = a_0}, where \eqn{a_0} is \code{hurdle_point}. This routine is used in
hurdle mode to estimate and compare candidates for the hurdle probability
\eqn{\pi(W) = P(A = a_0 \mid W)} via cross-validated Bernoulli negative
log-likelihood loss.

The function constructs a wide data set with outcome \code{in_hurdle =
as.integer(A == hurdle_point)} and covariates \code{W}. For each fold, each
learner is fit on the training partition and evaluated on the validation
partition. Each learner must supply \code{runner$logpi()}, returning an
\eqn{n_{\mathrm{valid}} \times K} matrix of \eqn{\log \hat\pi(W)} values, where
\eqn{K} is the number of tuning choices for that learner.
}
\details{
For a validation observation with outcome \eqn{y \in \{0,1\}} and predicted
hurdle probability \eqn{\hat\pi}, the Bernoulli negative log-likelihood loss is
\deqn{
  \ell(\hat\pi; y) = -\left\{ y \log(\hat\pi) + (1-y)\log(1-\hat\pi) \right\}.
}
This function expects hurdle runners to provide \eqn{\log \hat\pi(W)} and then
computes \eqn{\log(1-\hat\pi)} using \code{log1p(-pi)} after clamping
\eqn{\hat\pi} into \eqn{[\mathrm{eps}, 1-\mathrm{eps}]} for numerical stability.

Fold weights are defined as \code{sum(wts_valid)} for each validation fold and
are used downstream for weighted aggregation of fold losses.
}
