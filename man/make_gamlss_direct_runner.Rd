% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/runner_direct_gamlss.R
\name{make_gamlss_direct_runner}
\alias{make_gamlss_direct_runner}
\title{Create a GAMLSS runner for direct conditional density estimation}
\usage{
make_gamlss_direct_runner(
  mu_rhs_list,
  family_list = c("NO"),
  sigma_rhs_list = c("1"),
  nu_rhs_list = NULL,
  tau_rhs_list = NULL,
  use_weights_col = TRUE,
  strip_fit = TRUE,
  control = gamlss::gamlss.control(n.cyc = 50, trace = FALSE),
  eps = 1e-12,
  fallback = c("normal_lm", "none"),
  ...
)
}
\arguments{
\item{mu_rhs_list}{RHS specifications for the location parameter mu. May be
one-sided formulas (for example, ~ W1 + W2) or character strings
(for example, "W1 + W2"). Must have length at least 1.}

\item{family_list}{Character vector of GAMLSS family names (for example, "NO",
"TF", "BCCG"). Each family must have corresponding d<family>() and r<family>()
functions available in gamlss.dist.}

\item{sigma_rhs_list}{RHS specifications for the scale parameter sigma.
Defaults to "1". May be formulas or character strings.}

\item{nu_rhs_list}{Optional RHS specifications for the nu parameter. If NULL,
nu is not modeled.}

\item{tau_rhs_list}{Optional RHS specifications for the tau parameter. If NULL,
tau is not modeled.}

\item{use_weights_col}{Logical. If TRUE and the training data contain a column
named wts, it is passed to gamlss::gamlss() via weights. Otherwise, fitting
is unweighted.}

\item{strip_fit}{Logical. If TRUE, strip fitted gamlss or fallback models
before storing them.}

\item{control}{A gamlss.control() object controlling the fitting procedure.}

\item{eps}{Small positive constant used to bound log-densities away from
-Inf when fits fail or densities underflow.}

\item{fallback}{Character string specifying fallback behavior when a GAMLSS fit
fails. One of "normal_lm" or "none".}

\item{...}{Additional arguments forwarded to gamlss::gamlss().}
}
\value{
A named list (runner) with elements:
  method: Character string "gamlss".
  tune_grid: Data frame enumerating all family / RHS combinations, including .tune.
  fit: Function fit(train_set, ...) returning a fit bundle containing all fits.
  log_density: Function log_density(fit_bundle, newdata, ...) returning an n x K
    matrix of log-densities.
  density: Function density(fit_bundle, newdata, ...) returning densities on
    the original scale.
  fit_one: Function fit_one(train_set, tune, ...) fitting only the selected tuning index.
  select_fit: Function select_fit(fit_bundle, tune) extracting a single tuning configuration.
  sample: Function sample(fit_bundle, newdata, n_samp, ...) drawing samples from the
    fitted conditional density (assumes length(fit_bundle$fits) == 1).

Data requirements

The runner expects train_set and newdata in wide format containing:
  - a numeric outcome column A,
  - covariates referenced in the RHS specifications,
  - an optional weight column wts.
}
\description{
Constructs a runner (learner adapter) compatible with the
dsldensify() / summarize_and_select() workflow for direct conditional density
estimation of a continuous outcome A given covariates W using GAMLSS.
}
\details{
The runner fits one or more GAMLSS models via gamlss::gamlss(), allowing
specification of regression formulas for distribution parameters (mu, sigma,
and optionally nu and tau) and supports tuning over:
  - distribution family,
  - mu model (mu_rhs_list),
  - sigma model (sigma_rhs_list),
  - optional nu model (nu_rhs_list),
  - optional tau model (tau_rhs_list).

This is a direct density learner. log_density() evaluates log f(A | W)
directly and is used for cross-validated model selection on the negative
log-likelihood scale.

Robustness and fallback behavior

GAMLSS fits can fail to converge or error for certain combinations of
families and formulas. This runner supports fallback behavior:
  - fallback = "normal_lm": if a GAMLSS fit fails, fall back to a homoscedastic
    normal linear model for the mean with an empirical residual standard
    deviation.
  - fallback = "none": retain the failure and return finite log-densities
    bounded below by log(eps). Error objects are stored for debugging.

Numeric-only requirement

This runner assumes all covariates referenced in the RHS formulas are
numeric. Factor handling and categorical smooth terms are not supported.

Tuning grid and prediction layout

The internal tune_grid is the Cartesian product of family_list, mu_rhs_list,
sigma_rhs_list, and optionally nu_rhs_list and tau_rhs_list. Each row
corresponds to a distinct specification. During cross-validation,
log_density() returns an n x K matrix of log-densities, where K = nrow(tune_grid),
aligned to .tune.

Sampling from the fitted direct density model

The runner provides a sample() method that generates draws
  A* ~ f_hat(Â· | W)
from the fitted conditional density.

Sampling assumes the fit_bundle contains exactly one tuned fit
(length(fit_bundle$fits) == 1). This is the intended usage after model
selection (for example, after applying select_fit_tune() or fitting the
selected tuning index via fit_one()).

The sample() method expects newdata in wide format containing only covariates W.
It returns an nrow(newdata) x n_samp numeric matrix.

For GAMLSS fits, distribution parameters are obtained via
predictAll(type = "response") and sampling is performed using the
corresponding r<family>() function from gamlss.dist. For fallback normal
models, sampling uses rnorm() with mean predicted by the linear model and
constant sigma estimated on the training set.

Lightweight fit objects

When strip_fit = TRUE, fitted gamlss objects are stripped of large components
(responses, fitted values, residuals) before storage. This reduces memory usage
while preserving the ability to predict distribution parameters and evaluate
densities and samples.
}
\examples{
mu_rhs <- list(~ W1 + W2, ~ W1 + W2 + W3)

runner <- make_gamlss_runner(
  mu_rhs_list = mu_rhs,
  family_list = c("NO", "TF"),
  sigma_rhs_list = c("1", "~ W1"),
  fallback = "normal_lm"
)

}
