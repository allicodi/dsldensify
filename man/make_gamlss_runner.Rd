% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/runner_gamlss.R
\name{make_gamlss_runner}
\alias{make_gamlss_runner}
\title{Create a GAMLSS runner for direct conditional density estimation}
\usage{
make_gamlss_runner(
  mu_rhs_list,
  family_list = c("NO"),
  sigma_rhs_list = c("1"),
  nu_rhs_list = NULL,
  tau_rhs_list = NULL,
  use_weights_col = TRUE,
  strip_fit = TRUE,
  control = gamlss::gamlss.control(n.cyc = 50, trace = FALSE),
  eps = 1e-12,
  fallback = c("normal_lm", "none"),
  ...
)
}
\arguments{
\item{mu_rhs_list}{A list of RHS specifications for the location (mean)
parameter \code{mu}, either as one-sided formulas (e.g., \code{~ W1 + W2}) or
character strings (e.g., \code{"W1 + W2"}). Must have length \eqn{\ge 1}.}

\item{family_list}{Character vector of GAMLSS family names (e.g., \code{"NO"},
\code{"TF"}, \code{"BCCG"}). Each family must have a corresponding density
function \code{d<family>()} available in \pkg{gamlss.dist}.}

\item{sigma_rhs_list}{RHS specifications for the scale parameter \code{sigma}.
Defaults to \code{"1"} (constant scale). May be formulas or character strings.}

\item{nu_rhs_list}{Optional RHS specifications for the \code{nu} parameter
(e.g., skewness). If \code{NULL}, \code{nu} is not modeled.}

\item{tau_rhs_list}{Optional RHS specifications for the \code{tau} parameter
(e.g., kurtosis). If \code{NULL}, \code{tau} is not modeled.}

\item{use_weights_col}{Logical. If \code{TRUE} and the training data contain a
column named \code{wts}, it is passed to \code{gamlss::gamlss()} via the
\code{weights} argument. Otherwise, fitting is unweighted.}

\item{strip_fit}{Logical. If \code{TRUE} (default), apply a stripping step to
fitted GAMLSS or fallback models before storing them.}

\item{control}{A \code{gamlss.control()} object controlling the GAMLSS fitting
procedure (e.g., number of iterations, tracing). Defaults to a conservative,
quiet configuration suitable for CV.}

\item{eps}{Small positive constant used to bound log-densities away from
\eqn{-\infty} when fits fail or densities underflow.}

\item{fallback}{Character string specifying fallback behavior when a GAMLSS
fit fails. One of:
\describe{
  \item{\code{"normal_lm"}}{Fall back to a homoscedastic normal linear model
  for \code{mu}.}
  \item{\code{"none"}}{Do not fall back; failed fits return log(eps).}
}}

\item{...}{Additional arguments forwarded to \code{gamlss::gamlss()}.}
}
\value{
A named list (runner) with elements:
\describe{
  \item{method}{Character string \code{"gamlss"}.}
  \item{tune_grid}{Data frame enumerating all family / RHS combinations, with
  column \code{.tune}.}
  \item{fit}{Function \code{fit(train_set, ...)} returning a fit bundle
  containing all fitted (or failed/fallback) models.}
  \item{log_density}{Function \code{log_density(fit_bundle, newdata, ...)}
  returning an \code{n x K} matrix of log-densities.}
  \item{density}{Function \code{density(fit_bundle, newdata, ...)} returning
  densities on the original scale.}
  \item{fit_one}{Function \code{fit_one(train_set, tune, ...)} fitting only
  the selected tuning index.}
  \item{select_fit}{Function for extracting a single tuning from a fit bundle.}
}
}
\description{
Constructs a **runner** (learner adapter) compatible with the
\code{dsldensify()} / \code{summarize_and_select()} workflow for **direct
conditional density estimation** of a continuous outcome \code{A | W} using
generalized additive models for location, scale, and shape (GAMLSS).

The runner fits one or more GAMLSS models via \code{gamlss::gamlss()}, allowing
flexible specification of regression formulas for distribution parameters
(e.g., mean, scale, skewness, kurtosis) and supports tuning over:
\itemize{
  \item distribution family,
  \item mean model (\code{mu_rhs}),
  \item scale model (\code{sigma_rhs}),
  \item optional shape models (\code{nu_rhs}, \code{tau_rhs}).
}

This runner is intended for **direct density learners** (not hazard-based):
it returns log-densities \eqn{\log f(A | W)} directly, which are used for
cross-validated model selection on the negative log-likelihood scale.
}
\details{
## Data requirements
The runner expects \code{train_set} and \code{newdata} in **wide format**
containing:
\itemize{
  \item a numeric outcome column \code{A},
  \item covariates referenced in the RHS specifications,
  \item an optional weight column \code{wts}.
}

## Density evaluation
For GAMLSS fits, distribution parameters are obtained via
\code{predictAll(type = "response")}, and the log-density is evaluated using
the corresponding \code{d<family>()} function from \pkg{gamlss.dist}. For
fallback normal models, densities are computed using \code{dnorm()}.
}
\section{Robustness and fallback behavior}{

GAMLSS fits can occasionally fail to converge or error for certain combinations
of families and formulas, especially in small samples or during cross-validation.
To make large CV routines robust, this runner supports an optional **fallback
mechanism**:
\itemize{
  \item \code{fallback = "normal_lm"}: if a GAMLSS fit fails, fall back to a
        homoscedastic normal linear model for the mean with an empirical
        residual standard deviation.
  \item \code{fallback = "none"}: retain the failure and return a finite but
        extremely small log-density (via \code{eps}); error objects are stored
        for debugging.
}
}

\section{Numeric-only requirement}{

This runner assumes that all covariates referenced in the RHS formulas are
**numeric**. Factor handling, contrasts, and categorical smoothing terms are
not supported. Inputs are assumed to be preprocessed appropriately.
}

\section{Tuning grid and prediction layout}{

The internal \code{tune_grid} is the Cartesian product of:
\itemize{
  \item \code{family_list},
  \item \code{mu_rhs_list},
  \item \code{sigma_rhs_list},
  \item \code{nu_rhs_list} (if provided),
  \item \code{tau_rhs_list} (if provided).
}
Each row corresponds to a distinct GAMLSS specification. During
cross-validation, \code{log_density()} returns an \code{n x K} matrix of
log-densities, where \code{K = nrow(tune_grid)}, aligned to the tuning grid.
}

\section{Lightweight fit objects}{

When \code{strip_fit = TRUE}, fitted \code{gamlss} objects are stripped of
large components (responses, fitted values, residuals) before storage.
This substantially reduces memory usage when saving fold-specific CV fits,
while preserving the ability to:
\itemize{
  \item predict distribution parameters via \code{predictAll()},
  \item evaluate the log-density via the appropriate \code{d<family>()} function.
}
}

\examples{
mu_rhs <- list(~ W1 + W2, ~ splines::ns(W1, df = 3) + W2)

runner <- make_gamlss_runner(
  mu_rhs_list = mu_rhs,
  family_list = c("NO", "TF"),
  sigma_rhs_list = c("1", "~ W1"),
  fallback = "normal_lm"
)

}
